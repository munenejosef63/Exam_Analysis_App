{% extends "layout.html" %}

{% block title %}School Dashboard{% endblock %}

{% block extra_css %}
<style>
    .performance-card {
        transition: transform 0.3s;
    }
    .performance-card:hover {
        transform: translateY(-5px);
    }
    .progress {
        height: 1.5rem;
    }
    .trend-indicator {
        font-size: 1.2rem;
        margin-left: 5px;
    }
    .trend-up {
        color: #28a745;
    }
    .trend-down {
        color: #dc3545;
    }
    .trend-neutral {
        color: #6c757d;
    }
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    .badge-pill {
        min-width: 60px;
    }
    .subject-rank-item {
        transition: all 0.3s;
        border-left: 4px solid transparent;
    }
    .subject-rank-item:hover {
        transform: translateX(5px);
    }
    .rank-1 { border-left-color: #28a745; background-color: rgba(40, 167, 69, 0.1); }
    .rank-2 { border-left-color: #20c997; background-color: rgba(32, 201, 151, 0.1); }
    .rank-3 { border-left-color: #17a2b8; background-color: rgba(23, 162, 184, 0.1); }
    .rank-4 { border-left-color: #6c757d; background-color: rgba(108, 117, 125, 0.1); }
    .rank-5 { border-left-color: #ffc107; background-color: rgba(255, 193, 7, 0.1); }
    .rank-6 { border-left-color: #fd7e14; background-color: rgba(253, 126, 20, 0.1); }
    .rank-7 { border-left-color: #dc3545; background-color: rgba(220, 53, 69, 0.1); }

    /* Additional styles for ranking table */
    .ranking-table th {
        white-space: nowrap;
        position: sticky;
        top: 0;
        background: #f8f9fa;
    }
    .ranking-table td {
        vertical-align: middle;
    }
    .ranking-table .badge {
        font-size: 0.85rem;
        padding: 0.4em 0.6em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>{{ school.name }} {{ exams.name }} Dashboard</h2>
        {% if not school.is_active or school.subscription_expiry is none or school.subscription_expiry < current_date %}
            <a href="{{ url_for('payment.payment') }}" class="btn btn-danger">Renew Subscription</a>
        {% endif %}
    </div>

    {% if performance %}
    <!-- Student Performance Ranking Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Student Performance Ranking</h5>
                    <small class="text-muted">Showing {{ performance.all_students|length }} students</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover ranking-table">
                            <thead class="thead-light">
                                <tr>
                                    <th>Rank</th>
                                    <th>Student</th>
                                    <th>Class</th>
                                    {% for subject in performance.by_subject.keys() %}
                                    <th class="text-center">{{ subject }}</th>
                                    {% endfor %}
                                    <th class="text-center">Total</th>
                                    <th class="text-center">Average</th>
                                    <th class="text-center">Grade</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in performance.all_students|sort(attribute='total_score', reverse=True) %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>
                                        <strong>{{ student.name }}</strong>
                                        {% if loop.index <= 3 %}
                                            <span class="badge badge-warning ml-2">Top {{ loop.index }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ student.class_name }}</td>
                                    {% for subject in performance.by_subject.keys() %}
                                    <td class="text-center">
                                        {% if student.scores.get(subject, 0) >= 70 %}
                                            <span class="text-success">{{ student.scores.get(subject, 'N/A') }}</span>
                                        {% elif student.scores.get(subject, 0) >= 50 %}
                                            <span class="text-primary">{{ student.scores.get(subject, 'N/A') }}</span>
                                        {% else %}
                                            <span class="text-danger">{{ student.scores.get(subject, 'N/A') }}</span>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                    <td class="text-center font-weight-bold">{{ student.total_score }}</td>
                                    <td class="text-center">{{ "%.1f"|format(student.avg_score) }}</td>
                                    <td class="text-center">
                                        {% if student.avg_score >= 80 %}
                                            <span class="badge badge-success">A</span>
                                        {% elif student.avg_score >= 70 %}
                                            <span class="badge badge-primary">B</span>
                                        {% elif student.avg_score >= 60 %}
                                            <span class="badge badge-info">C</span>
                                        {% elif student.avg_score >= 50 %}
                                            <span class="badge badge-warning">D</span>
                                        {% else %}
                                            <span class="badge badge-danger">E</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="{{ 6 + performance.by_subject.keys()|length }}" class="text-center">No student data available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Summary Cards -->
    <div class="row mb-4">
        <!-- Mean Score Card -->
        <div class="col-md-3 mb-3">
            <div class="card performance-card text-white bg-primary h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">School/Class Mean Score</h5>
                    <p class="card-text display-4">
                        {{ "%.1f"|format(performance['overall']['mean']|default(0)) }}
                    </p>
                    {% if performance.trends.mean_trend is not none %}
                        <span class="trend-indicator
                            {% if performance.trends.mean_trend > 0 %}trend-up
                            {% elif performance.trends.mean_trend < 0 %}trend-down
                            {% else %}trend-neutral
                            {% endif %}">
                            {% if performance.trends.mean_trend > 0 %}&uarr;
                            {% elif performance.trends.mean_trend < 0 %}&darr;
                            {% else %}&rarr;
                            {% endif %}
                            {{ "%.1f"|format(performance.trends.mean_trend|abs) }}%
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Pass Rate Card -->
        <div class="col-md-3 mb-3">
            <div class="card performance-card text-white bg-success h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">Pass Rate</h5>
                    <p class="card-text display-4">
                        {{ "%.1f"|format(performance.overall.pass_rate|default(0)) }}%
                    </p>
                    {% if performance.trends.pass_rate_trend is not none %}
                        <span class="trend-indicator
                            {% if performance.trends.pass_rate_trend > 0 %}trend-up
                            {% elif performance.trends.pass_rate_trend < 0 %}trend-down
                            {% else %}trend-neutral
                            {% endif %}">
                            {% if performance.trends.pass_rate_trend > 0 %}&uarr;
                            {% elif performance.trends.pass_rate_trend < 0 %}&darr;
                            {% else %}&rarr;
                            {% endif %}
                            {{ "%.1f"|format(performance.trends.pass_rate_trend|abs) }}%
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Students Card -->
        <div class="col-md-3 mb-3">
            <div class="card performance-card text-white bg-info h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">Students</h5>
                    <p class="card-text display-4">
                        {{ performance.overall.total_students|default(0) }}
                    </p>
                    <small class="text-white-50">
                        Active: {{ performance.overall.active_students|default(0) }}
                    </small>
                </div>
            </div>
        </div>

        <!-- Subjects Card -->
        <div class="col-md-3 mb-3">
            <div class="card performance-card text-white bg-warning h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">Subjects</h5>
                    <p class="card-text display-4">
                        {{ performance.overall.total_subjects|default(0) }}
                    </p>
                    <small class="text-white-50">
                        Core: {{ performance.overall.core_subjects|default(0) }}
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Rest of the existing content remains the same -->
    <!-- Grade Distribution and Teacher Performance -->
    <div class="row mb-4">
        <!-- Grade Distribution -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5>Grade Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for grade, count in performance.grade_distribution.items() %}
                        <div class="col-md-4 mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Grade {{ grade }}</span>
                                <span>
                                    {{ count }}
                                    ({{ "%.1f"|format((count/performance.overall.total_results)*100 if performance.overall.total_results else 0) }}%)
                                </span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar"
                                     style="width: {{ (count/performance.overall.total_results)*100 if performance.overall.total_results else 0 }}%"
                                     aria-valuenow="{{ count }}"
                                     aria-valuemin="0"
                                     aria-valuemax="{{ performance.overall.total_results|default(1) }}">
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Teacher Performance -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5>Teacher Performance</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="thead-light">
                                <tr>
                                    <th>Teacher</th>
                                    <th>Subjects</th>
                                    <th>Avg Score</th>
                                    <th>Pass Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for teacher in performance.teacher_performance %}
                                <tr>
                                    <td>{{ teacher.name }}</td>
                                    <td>{{ teacher.subject_count }}</td>
                                    <td>{{ "%.1f"|format(teacher.avg_score|default(0)) }}</td>
                                    <td>{{ "%.1f"|format(teacher.pass_rate|default(0)) }}%</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center">No teacher data available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Charts -->
    <div class="row mb-4">
        <!-- Class Performance -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5>Performance by Class</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="classPerformanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subject Performance -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5>Performance by Subject</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="subjectPerformanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Subject Rankings and Student Performance -->
    <div class="row mb-4">
        <!-- Subject Rankings -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5>Subject Rankings by Average Score</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% set subjects_ranked = performance.by_subject.items()|sort(attribute='1.mean', reverse=True) %}
                        {% for subject, data in subjects_ranked %}
                        <div class="list-group-item subject-rank-item rank-{{ loop.index }}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ subject }}</h6>
                                    <small class="text-muted">{{ data.total_students }} students</small>
                                </div>
                                <div>
                                    <span class="badge badge-primary badge-pill">
                                        {{ "%.1f"|format(data.mean) }}
                                    </span>
                                    <small class="d-block text-right text-muted">
                                        {{ "%.1f"|format(data.pass_rate) }}% pass
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="list-group-item text-center">No subject data available</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Top & Bottom Students -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5>Top & Bottom Students</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-success">Top Performers</h6>
                            <ul class="list-group">
                                {% for student in performance.top_students %}
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ student.name }}</strong><br>
                                            <small class="text-muted">Grade: {{ student.grade }}</small>
                                        </div>
                                        <div class="text-right">
                                            <span class="badge badge-primary badge-pill">
                                                {{ "%.1f"|format(student.total_score|default(0)) }}
                                            </span><br>
                                            <small>Avg: {{ "%.1f"|format(student.avg_score|default(0)) }}</small>
                                        </div>
                                    </div>
                                </li>
                                {% else %}
                                <li class="list-group-item text-center">No data available</li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-danger">Needs Improvement</h6>
                            <ul class="list-group">
                                {% for student in performance.bottom_students %}
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ student.name }}</strong><br>
                                            <small class="text-muted">Grade: {{ student.grade }}</small>
                                        </div>
                                        <div class="text-right">
                                            <span class="badge badge-danger badge-pill">
                                                {{ "%.1f"|format(student.total_score|default(0)) }}
                                            </span><br>
                                            <small>Avg: {{ "%.1f"|format(student.avg_score|default(0)) }}</small>
                                        </div>
                                    </div>
                                </li>
                                {% else %}
                                <li class="list-group-item text-center">No data available</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Exams Table -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Recent Exams</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th>Exam</th>
                            <th>Date</th>
                            <th>Mean Score</th>
                            <th>Pass Rate</th>
                            <th>Students</th>
                            <th>Trend</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for exam in exams %}
                        <tr>
                            <td>{{ exam.name }}</td>
                            <td>{{ exam.exam_date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ "%.1f"|format(exam.mean_score) if exam.mean_score is not none else 'N/A' }}</td>
                            <td>{{ "%.1f"|format(exam.pass_rate) if exam.pass_rate is not none else 'N/A' }}%</td>
                            <td>{{ exam.student_count }}</td>
                            <td>
                                {% if exam.trend is not none %}
                                    <span class="{% if exam.trend > 0 %}text-success{% elif exam.trend < 0 %}text-danger{% else %}text-muted{% endif %}">
                                        {% if exam.trend > 0 %}&uarr;{% elif exam.trend < 0 %}&darr;{% else %}&rarr;{% endif %}
                                        {{ "%.1f"|format(exam.trend|abs) }}%
                                    </span>
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center">No recent exams found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        No performance data available. Upload exam results to get started.
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% if performance %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Class Performance Chart
        const classCtx = document.getElementById('classPerformanceChart').getContext('2d');
        const classLabels = {{ performance.by_class.keys()|list|tojson }};
        const classMeans = {{ performance.by_class.values()|map(attribute='mean')|list|default([])|tojson }};
        const classPassRates = {{ performance.by_class.values()|map(attribute='pass_rate')|list|default([])|tojson }};

        if (classLabels.length > 0 && classMeans.length > 0) {
            new Chart(classCtx, {
                type: 'bar',
                data: {
                    labels: classLabels,
                    datasets: [
                        {
                            label: 'Mean Score',
                            data: classMeans,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Pass Rate %',
                            data: classPassRates,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            type: 'line',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Mean Score' }
                        },
                        y1: {
                            beginAtZero: true,
                            max: 100,
                            position: 'right',
                            title: { display: true, text: 'Pass Rate %' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // Subject Performance Chart
        const subjectCtx = document.getElementById('subjectPerformanceChart').getContext('2d');
        const subjectLabels = {{ performance.by_subject.keys()|list|tojson }};
        const subjectMeans = {{ performance.by_subject.values()|map(attribute='mean')|list|default([])|tojson }};
        const subjectPassRates = {{ performance.by_subject.values()|map(attribute='pass_rate')|list|default([])|tojson }};

        if (subjectLabels.length > 0 && subjectMeans.length > 0) {
            new Chart(subjectCtx, {
                type: 'bar',
                data: {
                    labels: subjectLabels,
                    datasets: [
                        {
                            label: 'Mean Score',
                            data: subjectMeans,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Pass Rate %',
                            data: subjectPassRates,
                            backgroundColor: 'rgba(153, 102, 255, 0.7)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1,
                            type: 'line',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Mean Score' }
                        },
                        y1: {
                            beginAtZero: true,
                            max: 100,
                            position: 'right',
                            title: { display: true, text: 'Pass Rate %' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }
    });
</script>
{% endif %}
{% endblock %}