{% extends "layout.html" %}

{% block title %}School Dashboard{% endblock %}

{% block extra_css %}
<style>
    .performance-card {
        transition: transform 0.3s;
    }
    .performance-card:hover {
        transform: translateY(-5px);
    }
    .progress {
        height: 1.5rem;
    }
    .trend-indicator {
        font-size: 1.2rem;
        margin-left: 5px;
    }
    .trend-up {
        color: #28a745;
    }
    .trend-down {
        color: #dc3545;
    }
    .trend-neutral {
        color: #6c757d;
    }
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>{{ school.name }} Dashboard</h2>
        {% if not school.is_active or school.subscription_expiry < current_date %}
            <a href="{{ url_for('payment.payment') }}" class="btn btn-danger">Renew Subscription</a>
        {% endif %}
    </div>

    {% if performance %}
    <!-- Performance Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card performance-card text-white bg-primary h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">Mean Score</h5>
                    <p class="card-text display-4">{{ "%.1f"|format(performance.overall.mean) }}</p>
                    {% if performance.trends.mean_trend %}
                        <span class="trend-indicator {% if performance.trends.mean_trend > 0 %}trend-up{% elif performance.trends.mean_trend < 0 %}trend-down{% else %}trend-neutral{% endif %}">
                            {% if performance.trends.mean_trend > 0 %}&uarr;{% elif performance.trends.mean_trend < 0 %}&darr;{% else %}&rarr;{% endif %}
                            {{ "%.1f"|format(performance.trends.mean_trend|abs) }}%
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card performance-card text-white bg-success h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">Pass Rate</h5>
                    <p class="card-text display-4">{{ "%.1f"|format(performance.overall.pass_rate) }}%</p>
                    {% if performance.trends.pass_rate_trend %}
                        <span class="trend-indicator {% if performance.trends.pass_rate_trend > 0 %}trend-up{% elif performance.trends.pass_rate_trend < 0 %}trend-down{% else %}trend-neutral{% endif %}">
                            {% if performance.trends.pass_rate_trend > 0 %}&uarr;{% elif performance.trends.pass_rate_trend < 0 %}&darr;{% else %}&rarr;{% endif %}
                            {{ "%.1f"|format(performance.trends.pass_rate_trend|abs) }}%
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card performance-card text-white bg-info h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">Students</h5>
                    <p class="card-text display-4">{{ performance.overall.total_students }}</p>
                    <small class="text-white-50">Active: {{ performance.overall.active_students }}</small>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card performance-card text-white bg-warning h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">Subjects</h5>
                    <p class="card-text display-4">{{ performance.overall.total_subjects }}</p>
                    <small class="text-white-50">Core: {{ performance.overall.core_subjects }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Grade Distribution and Teacher Performance -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5>Grade Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for grade, count in performance.grade_distribution.items() %}
                        <div class="col-md-4 mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Grade {{ grade }}</span>
                                <span>{{ count }} ({{ "%.1f"|format((count/performance.overall.total_results)*100) }}%)</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar"
                                     style="width: {{ (count/performance.overall.total_results)*100 }}%"
                                     aria-valuenow="{{ count }}"
                                     aria-valuemin="0"
                                     aria-valuemax="{{ performance.overall.total_results }}">
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5>Teacher Performance</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="thead-light">
                                <tr>
                                    <th>Teacher</th>
                                    <th>Subjects</th>
                                    <th>Avg Score</th>
                                    <th>Pass Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for teacher in performance.teacher_performance %}
                                <tr>
                                    <td>{{ teacher.name }}</td>
                                    <td>{{ teacher.subject_count }}</td>
                                    <td>{{ "%.1f"|format(teacher.avg_score) }}</td>
                                    <td>{{ "%.1f"|format(teacher.pass_rate) }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Charts -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5>Performance by Class</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="classPerformanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5>Performance by Subject</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="subjectPerformanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trend Analysis and Student Performance -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5>Performance Trend</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="performanceTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5>Top & Bottom Students</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-success">Top Performers</h6>
                            <ul class="list-group">
                                {% for student in performance.top_students %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    {{ student.name }}
                                    <span class="badge badge-primary badge-pill">{{ "%.1f"|format(student.avg_score) }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-danger">Needs Improvement</h6>
                            <ul class="list-group">
                                {% for student in performance.bottom_students %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    {{ student.name }}
                                    <span class="badge badge-danger badge-pill">{{ "%.1f"|format(student.avg_score) }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Exams Table -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Recent Exams</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th>Exam</th>
                            <th>Date</th>
                            <th>Mean Score</th>
                            <th>Pass Rate</th>
                            <th>Students</th>
                            <th>Trend</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for exam in exams %}
                        <tr>
                            <td>{{ exam.name }}</td>
                            <td>{{ exam.exam_date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ "%.1f"|format(exam.mean_score) if exam.mean_score else 'N/A' }}</td>
                            <td>{{ "%.1f"|format(exam.pass_rate) }}%</td>
                            <td>{{ exam.student_count }}</td>
                            <td>
                                {% if exam.trend %}
                                    <span class="{% if exam.trend > 0 %}text-success{% elif exam.trend < 0 %}text-danger{% else %}text-muted{% endif %}">
                                        {% if exam.trend > 0 %}&uarr;{% elif exam.trend < 0 %}&darr;{% else %}&rarr;{% endif %}
                                        {{ "%.1f"|format(exam.trend|abs) }}%
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        No performance data available. Upload exam results to get started.
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% if performance %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Class Performance Chart
    document.addEventListener('DOMContentLoaded', function() {
        const classCtx = document.getElementById('classPerformanceChart').getContext('2d');
        const classLabels = {{ performance.by_class.keys()|list|tojson }};
        const classMeans = {{ performance.by_class.values()|map(attribute='mean')|list|tojson }};
        const classPassRates = {{ performance.by_class.values()|map(attribute='pass_rate')|list|tojson }};

        new Chart(classCtx, {
            type: 'bar',
            data: {
                labels: classLabels,
                datasets: [
                    {
                        label: 'Mean Score',
                        data: classMeans,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Pass Rate %',
                        data: classPassRates,
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        type: 'line',
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Mean Score'
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        max: 100,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Pass Rate %'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });

        // Subject Performance Chart
        const subjectCtx = document.getElementById('subjectPerformanceChart').getContext('2d');
        const subjectLabels = {{ performance.by_subject.keys()|list|tojson }};
        const subjectMeans = {{ performance.by_subject.values()|map(attribute='mean')|list|tojson }};
        const subjectPassRates = {{ performance.by_subject.values()|map(attribute='pass_rate')|list|tojson }};

        new Chart(subjectCtx, {
            type: 'bar',
            data: {
                labels: subjectLabels,
                datasets: [
                    {
                        label: 'Mean Score',
                        data: subjectMeans,
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Pass Rate %',
                        data: subjectPassRates,
                        backgroundColor: 'rgba(153, 102, 255, 0.7)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1,
                        type: 'line',
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Mean Score'
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        max: 100,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Pass Rate %'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });

        // Performance Trend Chart
        const trendCtx = document.getElementById('performanceTrendChart').getContext('2d');
        const trendLabels = {{ performance.trends.exam_periods|list|tojson }};
        const trendMeans = {{ performance.trends.mean_scores|list|tojson }};
        const trendPassRates = {{ performance.trends.pass_rates|list|tojson }};

        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendLabels,
                datasets: [
                    {
                        label: 'Mean Score',
                        data: trendMeans,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Pass Rate %',
                        data: trendPassRates,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    });
</script>
{% endif %}
{% endblock %}